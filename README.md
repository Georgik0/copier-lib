# storage-api


#### Абстракции

- abstractStorage - хранилище. Содержит свой уникальный `id` и `map[FileID][]Data`
  - `FileID` - идентификатор файла
  - `Data` - содержит `[]byte` (т.е. какая-то часть исходного файла) и `order` (т.е. порядок этой части для склейки файла)

Каждое хранилище может содержать несколько частей одного файла, поэтому здесь реализован метод цепочек. Каждому `FileID` в map соответствует слайс из частей исходного файла

- storageProvider - содержит `abstractStorage` и `occupancy` (заполненность хранилища)
- dispatcher - содержит следующие параметры:
  - `[]storageProvider`
  - `avgOccupancy` - float64 средняя заполненность всех хранилищ
  - `storageIdsForData` - `map[FileID][]int`. Эта map нужна для сохранения id хранилищ в которых лежат части исходного файла

---

#### Алгоритм и архитектура

При сохранении файла происходит его деление на несколько частей.  

Части файла отправляются в метод dispatcher.SetData()

Как выбирается хранилище:
- Каждое хранилище имеет параметр своей "заполненности".
- Если текущее значение "заполненности" не превышает среднее значение по всем хранилищам - выбирается это хранилище

При записи происходит пересчет средней "заполненности" хранилищ и обновляется `occupancy` для текущего хранилища

В процессе сохранения запоминаются id использованных хранилищ.

---

### Что не было сделано и что можно улучшить

- деление файла на части
- метод получения сохраненных файлов
- При увеличении кол-ва хранилищ, новые хранилища добавляются в конец слайса. Средняя "заполненность" будет пересчитана,
  но возможны ситуации, когда новые пустые хранилища долгое время не будут использованы для записи.
  - Это можно исправить добавлением приоритетности.
    Чтобы заполнялись сначала наиболее приоритетные, а только потом ориентироваться на `occupancy`
- Чтение/запись из хранилищ должны по возможности выполняться параллельно.
- При сохранении файла все походы в разные хранилища должны выполняться в рамках транзакции с возможностью роллбэка.
- Сейчас файлы с одинаковым названием всегда будут интерпретироваться одинаково.
- Нельзя сохранить файл с одинаковым названием больше одного раза. Нужно дорабатывать структуру данных, в которой хранятся файлы
